---
title: "Estudo de Caso - Diagnóstico de Câncer de Mama"
author: "Bruno Crotman"
date: "25/06/2019"
header-includes:
- \usepackage[portuguese]{babel}
output: 
    pdf_document:
        toc: true
        number_sections: true
        fig_caption: yes

bibliography: bib.bib           
        

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)


library(caret)
library(tidyverse)
library(scales)
library(GGally)
library(pROC)
library(plotROC)
library(xtable)
library(knitr)
library(magrittr)


dados <- read_csv("wdbc.csv") %>% 
    select(-"ID number") %>% 
    rename_all( .funs = ~str_replace(.,"fractal-media ","fractal_")   ) %>% 
    rename_all( .funs = ~str_replace(.,"fractal-pior ","fractal_")   ) %>% 
    rename_all( .funs = ~str_replace(.,"fractal-dv ","fractal_")   ) %>% 
    rename("fractal_dimension-media" = "fractal_dimension-meia") %>% 
    rename_all( .funs = ~str_replace(.,"-","_")   ) %>% 
    rename_all( .funs = ~str_replace(.," ","_")   ) %>% 
    mutate(Diagnosis = as.factor(Diagnosis)) 


set.seed(13)



rows <- sample(nrow(dados))

dados <- dados[rows,]


split <- round(nrow(dados) * .70 )

treino <- dados[1:split, ]

teste <- dados[(split + 1):nrow(dados), ]





```



```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(tidyverse)
library(texreg)
library(xtable)
library(broom)

options(OutDec = ",")

```



\section{Origem dos dados}

Os dados utilizados vieram do site [UCI Machine Learning Repository - Breast Cancer Wisconsin (Diagnostic) Data Set](https://archive.ics.uci.edu/ml/datasets/Breast+Cancer+Wisconsin+(Diagnostic))

A base contém `r nrow(dados)` casos, com `r ncol(dados)` variáveis, sendo uma delas o diagnóstico de benigno ou maligno.


\section{Conjuntos Treino e Teste}


Já antes do início da análise, a base foi dividida aleatoriamente em dados de teste e dados de treino. Os dados de teste não foram tocados durante nenhuma parte da análise. Apenas na avaliação final dos modelos, na Seção \ref{aval}.

Os dados de treino e teste constituem, respectivamente, `r    percent(nrow(treino)/nrow(dados), decimal.mark = ",", accuracy = 1)` e `r percent(nrow(teste)/nrow(dados) , decimal.mark = ",", accuracy = 1 )` do total.


\section{Exploração da base}

Foi realizada uma pequena exploração da base a fim de tentar encontrar padrões que saltassem aos olhos.


Por conta do grande número de variáveis, elas foram divididas em três grupos de dez. As variáveis que representam médias foram agrupadas em um conjunto, assim como as variáveis que representam desvios-padrão em outro grupo e as que representam piores medidas em ainda outro grupo.

As Figuras \ref{fig:corr_medias}, \ref{fig:corr_piores} e \ref{fig:corr_dp} apresentam as correlações entre as variáveis de cada grupo. É possível notar que existe uma correlação positiva relevante entre muitas das variáveis, sugerindo a possibilidade da diminuição da dimensionalidade do problema sem uma relevante perda de informação.


As Figuras \ref{fig:resumo_medias}, \ref{fig:resumo_piores} e \ref{fig:resumo_dps} apresentam um resumo das distribuições das variáveis e suas relações. As variáveis apresentam, de modo geral, valores maiores nos casos de diagnóstico maligno.


```{r message=FALSE, warning=FALSE, paged.print=FALSE}




medias <- treino %>% 
    select_at(vars(ends_with("_media"),Diagnosis)) %>% 
    rename_all( .funs = ~str_replace(.,"_media","")   ) %>% 
    rename_all( .funs = ~str_replace(.," ","_")   ) 
    


piores <- treino %>% 
    select_at(vars(ends_with("_pior"),Diagnosis)) %>% 
    rename_all( .funs = ~str_replace(.,"_pior","")   )  %>% 
    rename_all( .funs = ~str_replace(.," ","_")   ) 


dps <- treino %>% 
    select_at(vars(ends_with("_dv"),Diagnosis)) %>% 
    rename_all( .funs = ~str_replace(.,"_dv","")   ) %>% 
    rename_all( .funs = ~str_replace(.," ","_")   )  


```



```{r fig.cap="\\label{fig:corr_medias}Correlação entre as variáveis que representam médias", message=FALSE, warning=FALSE, cache=TRUE, paged.print=FALSE}

ggcorr(medias %>% select(-Diagnosis), legend.size = 8) +
    ggtitle("Correlações entre as médias", subtitle = "É possível observar que há muitas variáveis bastante \n correlacionadas")

```



```{r fig.cap="\\label{fig:resumo_medias}Resumo das distribuições das variáveis que representam médias", message=FALSE, warning=FALSE, paged.print=FALSE ,cache= TRUE}

ggpairs(medias ) +
    theme_grey(base_size = 8) +
        ggtitle("Resumo das distribuições", subtitle = "É possível observar que o valor da maioria das variáveis se mostra maior para os resultados malignos")



```



```{r, fig.cap="\\label{fig:corr_piores}Correlação entre as variáveis que representam as piores medidas.", message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}
ggcorr(piores %>% select(-Diagnosis), legend.size = 8) +
    ggtitle("Correlações entre as piores medidas", subtitle = "É possível observar que há muitas variáveis bastante \n correlacionadas")

```




```{r fig.cap="\\label{fig:resumo_piores}Resumo das distribuições das variáveis que representam piores medidas", message=FALSE, warning=FALSE, paged.print=FALSE, cache= TRUE}
ggpairs(piores ) +
    theme_grey(base_size = 8) +
        ggtitle("Resumo das distribuições", subtitle = "É possível observar que o valor da maioria das variáveis se mostra maior para os resultados malignos")

```


```{r, fig.cap="\\label{fig:corr_dp}Correlação entre as variáveis que representam os desvios-padrão.", message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}


ggcorr(dps %>% select(-Diagnosis), legend.size = 8) +
    ggtitle("Correlações entre os desvios-padrão", subtitle = "É possível observar que há muitas variáveis bastante \n correlacionadas")


```





```{r fig.cap="\\label{fig:resumo_dps}Resumo das distribuições das variáveis que representam desvios-padrão das medidas", message=FALSE, warning=FALSE, paged.print=FALSE , cache= TRUE}

ggpairs(dps ) +
    theme_grey(base_size = 8) +
        ggtitle("Resumo das distribuições", subtitle = "É possível observar que o valor da maioria das variáveis se mostra maior para os resultados malignos")


```

\newpage

\section{Modelos de classificação}


Nesta seção são apresentados os modelos de classificação utilizados e treinados. Também é mostrada a escolha da melhor parametrização de cada modelo.

Todos os modelos foram testados em esquema 4-Fold-validation repetido 5 vezes, para melhor avaliação da variância do modelo. Assim, temos no total 20 avaliações de cada parametrização de cada modelo. Cada caso da massa de dados de teste participa de 5 avaliações de cada parametrização.

A métrica escolhida para seleção da melhor parametrização e para a avaliação dos modelos nesta fase de treinamento foi a métrica AUC (area under the curve), que consiste na área sob a curva ROC. A curva ROC é a linha, no eixo cartesiano, que passa pelos pontos $(x_t,y_t)$ onde o valor de $y_t$ é a fração de verdadeiros positivos para um determinado threshold $t$ e o valor de $x_t$ é a fração de valores de falsos positivos para o threshold $t$. Os vários pontos são tomados para diversos valores de $t$. Desde valores de threshold mais altos, que favorecem poucos falsos positivos até valores mais baixos, que favorecem a detecção de todos os casos positivos. Com o valor do AUC é possível, então, avaliar a parametrização que se comporta melhor em todos os pontos deste trade-off.




```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

set.seed(13)


controle_cv <- trainControl(
    
    summaryFunction = twoClassSummary,
    classProbs = TRUE,
    verboseIter = FALSE,
    #index = folds, 
    returnResamp = "all",
    number = 4,
    repeats = 10,
    returnData = TRUE,
    savePredictions = "all",
    method = "repeatedcv",
    #,
    allowParallel = FALSE,
    # seeds = 1:41
    

)


```


\subsection{Regressão logística}



A figura \ref{fig:reg_log} mostra as curvas ROC para a regressão logística simples usando todas as 30 variáveis originais.

As variáveis do conjunto de treinamento foram pré-processadas para que fossem centralizadas em zero e escaladas para o desvio-padrão.

A Tabela \ref{tab_auc_reglog} mostra os resultados para cada fold da regressão logística. A tabela \ref{tab_auc_reglog_grup} mostra os resultados consolidados em média e desvio-padrão. Assim podemos ter a ideia do viés fora da amostra e da variância do modelo. 

\newpage


```{r fig.cap="\\label{fig:reg_log}Representação das curvas ROC de todas as avaliações da regressão logística", message=FALSE, warning=FALSE, paged.print=FALSE}




model_logistic <- train(
    
    Diagnosis ~ . ,
    treino,
    metric = "ROC",
    method = "glm",
    trControl = controle_cv,
    preProcess = c( "center", "scale"),
    family=binomial(link='logit')
    
    

)



ggplot(model_logistic$pred, aes(m = M, d = obs, color = Resample )) +
    geom_roc( labels = FALSE  ) +
    coord_equal() + style_roc() + ggtitle("ROC", subtitle = "Métricas para diversos thresholds" )+ style_roc()



```





```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}


result_model_logistic <-  model_logistic$resample %>% 
    select(Resample, ROC) %>%
    rename(AUC = ROC) 


result_model_logistic %>% 
    mutate_if(is.numeric, percent) %>% 
    kable( caption = "\\label{tab_auc_reglog}Métricas para cada Fold da regressão logistica")


```

Vemos um resultado com  viés e variância ruins


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}


result_model_logistic %>%     
    summarise(media = mean(AUC), sd = sd(AUC)) %>% 
    rename("Média AUC" = media, "Desvio-padrão AUC" = sd) %>% 
    mutate_if(is.numeric, percent) %>% 
    kable(caption = "\\label{tab_auc_reglog_grup}Média e desvio-padrão da Métrica AUC para regressão logistica")
    


```

Na regressão logística podemos enxergar claramente o coeficiente das variáveis explicativas. O modelo final mostrado na Tabela \ref{reg:log} mostra que nenhum coeficiente tem significado estatístico. Isso pode ser um efeito colateral de um número muito grande de variáveis explicativas correlacionadas.


```{r results='asis', message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}


texreg(model_logistic$finalModel, custom.model.names = c("Regressão logística simples"), caption = "Coeficientes estimados na regressão logística", label = "reg:log", fontsize = "footnotesize")



```

\newpage

Existem alguns pares de variáveis extremamente correlacionados, como mostra a Tabela \ref{tab_corr}. A chance de que seja necessário ter as duas variáveis é pequena. 


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}
correlacoes <- cor(as.matrix(treino %>% select(-Diagnosis)))

correlacoes_df <- as_tibble(correlacoes) 

correlacoes_df <- correlacoes_df %>% 
    bind_cols(tibble(coluna1 = names(correlacoes_df))) %>% 
    gather( coluna2, correlacao, -coluna1  ) %>% 
    filter(coluna1 != coluna2) %>% 
    arrange(desc(correlacao)) %>% 
    mutate(coluna1_menor = coluna1 < coluna2) %>% 
    filter(coluna1_menor) %>% 
    select(-coluna1_menor) 

correlacoes_df %>% 
    rename(var1 = coluna1, var2 = coluna2) %>% 
    filter(correlacao > 0.9) %>% 
    kable(digits = 3, caption = "\\label{tab_corr}Correlações entre variáveis: apenas as maiores que 0,9" )


```


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}
media_roc_formula <- function(formula, dados)
{
    
    set.seed(13)
    
    
    
    
    model_logistic <- train(

        as.formula(formula),
        dados,
        metric = "ROC",
        method = "glm",
        trControl = controle_cv,
        preProcess = c( "center", "scale"),
        family=binomial(link='logit')
        

    )

    retorno <- model_logistic$resample %>%
        select(-parameter) %>%
        gather(metrica, valor, -Resample) %>%
        group_by(metrica) %>%
        summarise(media = mean(valor), dp = sd(valor) ) %>%
        filter(metrica == "ROC")
    
    media <- retorno %>% pull(media)
    dp <- retorno %>% pull(dp)

    list(media,dp)


}

```



Para criar um modelo com menos variáveis correlacionadas, que tende a possuir menor variância, é necessário retirar algumas delas.

Para cada par de variáveis mais correlacionadas $x_i, x_j$, foi testado um modelo de regressão logística sem a variável $x_i$ e outro sem a variável $x_j$. A variável que participou do modelo de pior resultado foi marcada para exclusão.


A Tabela \ref{tab_pares_com_result} mostra o resultado deste processo de exclusão de variáveis para correlações maiores que 0,95. O resultado da média e do desvio-padrão do AUC para este processo de exclusão para mais de 0.95 é mostrado em \ref{tab_95}. A especificação resultante da regressão é mostrada na Tabela \ref{reg:log_95}.

O mesmo processo foi feito para níveis de correlação de 0,90, 0,85, 0,80, 0,75, 0,70 e 0,60. As Tabelas \ref{tab_90}, \ref{tab_85}, \ref{tab_80}, \ref{tab_75}, \ref{tab_70} e \ref{tab_60} mostram os resultados AUC. As tabelas \ref{reg:log_90}, \ref{reg:log_85}, \ref{reg:log_80}, \ref{reg:log_75}, \ref{reg:log_70}, \ref{reg:log_60} mostram as especificações das regressões. É posível ver que as regressões à medida em que o número de variáveis explicativas diminui, mais variáveis estatisticamente significativas vão aparecendo. O melhor resultado em termos de AUC se dá para a retirada de variáveis até 0,7 de correlação.




\newpage


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE  }
pares_avaliacao <- correlacoes_df %>% 
    mutate(par = row_number()) %>% 
    gather(variavel, valor,-correlacao, -par  ) %>% 
    mutate(formula =paste0("Diagnosis ~ . -", valor)) %>% 
    filter(correlacao > 0.95 ) 



result_pares_avaliacao <- pares_avaliacao %>%  
    rowwise() %>% 
    do( resultado = media_roc_formula(.$formula, treino)    ) %>% 
    as.tibble() 

pares_avaliacao_com_result <-  pares_avaliacao %>% 
    bind_cols(result_pares_avaliacao) %>% 
    unnest() %>% 
    mutate(indice =  if_else((row_number()-1) %% 2   == 0,"media","dp" )) %>% 
    spread(indice, resultado) %>% 
    mutate(media = unlist(media)) %>% 
    select(par, correlacao, valor, formula, media, dp ) %>% 
    group_by(par) %>% 
    mutate(maior_media = max(media)) %>% 
    mutate(exclui = media != maior_media ) %>% 
    ungroup() %>% 
    arrange(par, desc(media))




    
```

```{r message=FALSE, warning=FALSE, cache=TRUE, paged.print=FALSE}

pares_avaliacao_com_result %>% 
    mutate(dp = unlist(dp) ) %>% 
    kable( digits = 3, caption = "\\label{tab_pares_com_result}Resultado da exclusão de variáveis para correlações maiores que 0,95")


```




```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

set.seed(13)



formula_sem_variaveis <- pares_avaliacao_com_result %>%
    filter(exclui) %>% 
    select(valor) %>% 
    summarise(valor = paste0(" Diagnosis ~ . -",str_flatten(valor, collapse = " -"))) %>% 
    unlist()
    
model_logistic_sem_correlacionadas <- train(
    
    as.formula(formula_sem_variaveis),
    treino,
    metric = "ROC",
    method = "glm",
    trControl = controle_cv,
    preProcess = c( "center", "scale"),
    family=binomial(link='logit')
    

)



```



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}


result_model_logistic_sem_corr <-  model_logistic_sem_correlacionadas$resample %>% 
    select(Resample, ROC) %>%
    rename(AUC = ROC) 



```

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}


result_model_logistic_sem_corr %>%     
    summarise(media = mean(AUC), sd = sd(AUC)) %>% 
    rename("Média AUC" = media, "Desvio-padrão AUC" = sd) %>% 
    mutate_if(is.numeric, percent) %>% 
    kable(caption = "\\label{tab_95}Resultados para retirada de variáveis com correlação maior que 0,95")


```




```{r message=FALSE, warning=FALSE, cache=TRUE, paged.print=FALSE, results='asis'}


texreg(model_logistic_sem_correlacionadas$finalModel, fontsize = "footnotesize", custom.model.names = c("Regressão logística"), caption = "Coeficientes estimados na regressão logística com exclusão de uma variável em pares com mais de 0.95 de correlação", label = "reg:log_95")

```


\newpage


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE }
pares_avaliacao_90 <- correlacoes_df %>% 
    mutate(par = row_number()) %>% 
    gather(variavel, valor,-correlacao, -par  ) %>% 
    mutate(formula =paste0("Diagnosis ~ . -", valor)) %>% 
    filter(correlacao > 0.90 ) 



result_pares_avaliacao_90 <- pares_avaliacao_90 %>%  
    rowwise() %>% 
    do( resultado = media_roc_formula(.$formula, treino)    ) %>% 
    as.tibble() 

pares_avaliacao_com_result_90 <-  pares_avaliacao_90 %>% 
    bind_cols(result_pares_avaliacao_90) %>% 
    unnest() %>% 
    mutate(indice =  if_else((row_number()-1) %% 2   == 0,"media","dp" )) %>% 
    spread(indice, resultado) %>% 
    mutate(media = unlist(media)) %>% 
    select(par, correlacao, valor, formula, media, dp ) %>% 
    group_by(par) %>% 
    mutate(maior_media = max(media)) %>% 
    mutate(exclui = media != maior_media ) %>% 
    ungroup() %>% 
    arrange(par, desc(media))



```


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

set.seed(13)

formula_sem_variaveis_90 <- pares_avaliacao_com_result_90 %>%
    filter(exclui) %>% 
    select(valor) %>% 
    summarise(valor = paste0(" Diagnosis ~ . -",str_flatten(valor, collapse = " -"))) %>% 
    unlist()
    
model_logistic_sem_correlacionadas_90 <- train(
    
    as.formula(formula_sem_variaveis_90),
    treino,
    metric = "ROC",
    method = "glm",
    trControl = controle_cv,
    preProcess = c( "center", "scale"),
    family=binomial(link='logit')
    

)


    



```



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

result_model_logistic_sem_corr_90 <-  model_logistic_sem_correlacionadas_90$resample %>% 
    select(Resample, ROC) %>%
    rename(AUC = ROC) 




```

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}



result_model_logistic_sem_corr_90 %>%     
    summarise(media = mean(AUC), sd = sd(AUC)) %>% 
    rename("Média AUC" = media, "Desvio-padrão AUC" = sd) %>% 
    mutate_if(is.numeric, percent) %>% 
    kable(caption = "\\label{tab_90}Resultados para retirada de variáveis com correlação maior que 0,90")


```




```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, results='asis'}


texreg(model_logistic_sem_correlacionadas_90$finalModel, fontsize = "footnotesize", custom.model.names = c("Regressão logística"), caption = "Coeficientes estimados na regressão logística com exclusão de uma variável em pares com mais de 0,90 de correlação", label = "reg:log_90" )

```






\newpage

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE }
pares_avaliacao_85 <- correlacoes_df %>% 
    mutate(par = row_number()) %>% 
    gather(variavel, valor,-correlacao, -par  ) %>% 
    mutate(formula =paste0("Diagnosis ~ . -", valor)) %>% 
    filter(correlacao > 0.85 ) 



result_pares_avaliacao_85 <- pares_avaliacao_85 %>%  
    rowwise() %>% 
    do( resultado = media_roc_formula(.$formula, treino)    ) %>% 
    as.tibble() 

pares_avaliacao_com_result_85 <-  pares_avaliacao_85 %>% 
    bind_cols(result_pares_avaliacao_85) %>% 
    unnest() %>% 
    mutate(indice =  if_else((row_number()-1) %% 2   == 0,"media","dp" )) %>% 
    spread(indice, resultado) %>% 
    mutate(media = unlist(media)) %>% 
    select(par, correlacao, valor, formula, media, dp ) %>% 
    group_by(par) %>% 
    mutate(maior_media = max(media)) %>% 
    mutate(exclui = media != maior_media ) %>% 
    ungroup() %>% 
    arrange(par, desc(media))



```


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

set.seed(13)

formula_sem_variaveis_85 <- pares_avaliacao_com_result_85 %>%
    filter(exclui) %>% 
    select(valor) %>% 
    summarise(valor = paste0(" Diagnosis ~ . -",str_flatten(valor, collapse = " -"))) %>% 
    unlist()
    
model_logistic_sem_correlacionadas_85 <- train(
    
    as.formula(formula_sem_variaveis_85),
    treino,
    metric = "ROC",
    method = "glm",
    trControl = controle_cv,
    preProcess = c( "center", "scale"),
    family=binomial(link='logit')
    

)






```



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

result_model_logistic_85 <-  model_logistic_sem_correlacionadas_85$resample %>% 
    select(Resample, ROC) %>%
    rename(AUC = ROC) 



```

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}





result_model_logistic_85 %>%     
    summarise(media = mean(AUC), sd = sd(AUC)) %>% 
    rename("Média AUC" = media, "Desvio-padrão AUC" = sd) %>% 
    mutate_if(is.numeric, percent) %>% 
    kable(caption = "\\label{tab_85}Resultados para retirada de variáveis com correlação maior que 0,85")


```



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, results='asis'}


texreg(model_logistic_sem_correlacionadas_85$finalModel, fontsize = "footnotesize", custom.model.names = c("Regressão logística"), caption = "Coeficientes estimados na regressão logística com exclusão de uma variável em pares com mais de 0,85 de correlação", label = "reg:log_85",)

```



\newpage

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE }
pares_avaliacao_80 <- correlacoes_df %>% 
    mutate(par = row_number()) %>% 
    gather(variavel, valor,-correlacao, -par  ) %>% 
    mutate(formula =paste0("Diagnosis ~ . -", valor)) %>% 
    filter(correlacao > 0.80 ) 



result_pares_avaliacao_80 <- pares_avaliacao_80 %>%  
    rowwise() %>% 
    do( resultado = media_roc_formula(.$formula, treino)    ) %>% 
    as.tibble() 

pares_avaliacao_com_result_80 <-  pares_avaliacao_80 %>% 
    bind_cols(result_pares_avaliacao_80) %>% 
    unnest() %>% 
    mutate(indice =  if_else((row_number()-1) %% 2   == 0,"media","dp" )) %>% 
    spread(indice, resultado) %>% 
    mutate(media = unlist(media)) %>% 
    select(par, correlacao, valor, formula, media, dp ) %>% 
    group_by(par) %>% 
    mutate(maior_media = max(media)) %>% 
    mutate(exclui = media != maior_media ) %>% 
    ungroup() %>% 
    arrange(par, desc(media))



```


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

set.seed(13)

formula_sem_variaveis_80 <- pares_avaliacao_com_result_80 %>%
    filter(exclui) %>% 
    select(valor) %>% 
    summarise(valor = paste0(" Diagnosis ~ . -",str_flatten(valor, collapse = " -"))) %>% 
    unlist()
    
model_logistic_sem_correlacionadas_80 <- train(
    
    as.formula(formula_sem_variaveis_80),
    treino,
    metric = "ROC",
    method = "glm",
    trControl = controle_cv,
    preProcess = c( "center", "scale"),
    family=binomial(link='logit')
    

)






```



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

result_model_logistic_80 <-  model_logistic_sem_correlacionadas_80$resample %>% 
    select(Resample, ROC) %>%
    rename(AUC = ROC) 



```

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}




result_model_logistic_80 %>%     
    summarise(media = mean(AUC), sd = sd(AUC)) %>% 
    rename("Média AUC" = media, "Desvio-padrão AUC" = sd) %>% 
    mutate_if(is.numeric, percent) %>% 
    kable(caption = "\\label{tab_80}Resultados para retirada de variáveis com correlação maior que 0,80")


```




```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, results='asis'}


texreg(model_logistic_sem_correlacionadas_80$finalModel, fontsize = "footnotesize", custom.model.names = c("Regressão logística"), caption = "Coeficientes estimados na regressão logística com exclusão de uma variável em pares com mais de 0,80 de correlação", label = "reg:log_80",)

```




\newpage

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE }
pares_avaliacao_75 <- correlacoes_df %>% 
    mutate(par = row_number()) %>% 
    gather(variavel, valor,-correlacao, -par  ) %>% 
    mutate(formula =paste0("Diagnosis ~ . -", valor)) %>% 
    filter(correlacao > 0.75 ) 



result_pares_avaliacao_75 <- pares_avaliacao_75 %>%  
    rowwise() %>% 
    do( resultado = media_roc_formula(.$formula, treino)    ) %>% 
    as.tibble() 

pares_avaliacao_com_result_75 <-  pares_avaliacao_75 %>% 
    bind_cols(result_pares_avaliacao_75) %>% 
    unnest() %>% 
    mutate(indice =  if_else((row_number()-1) %% 2   == 0,"media","dp" )) %>% 
    spread(indice, resultado) %>% 
    mutate(media = unlist(media)) %>% 
    select(par, correlacao, valor, formula, media, dp ) %>% 
    group_by(par) %>% 
    mutate(maior_media = max(media)) %>% 
    mutate(exclui = media != maior_media ) %>% 
    ungroup() %>% 
    arrange(par, desc(media))

```



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

formula_sem_variaveis_75 <- pares_avaliacao_com_result_75 %>%
    filter(exclui) %>% 
    select(valor) %>% 
    summarise(valor = paste0(" Diagnosis ~ . -",str_flatten(valor, collapse = " -"))) %>% 
    unlist()
    
model_logistic_sem_correlacionadas_75 <- train(
    
    as.formula(formula_sem_variaveis_75),
    treino,
    metric = "ROC",
    method = "glm",
    trControl = controle_cv,
    preProcess = c( "center", "scale"),
    family=binomial(link='logit')
    

)


    



```



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

result_model_logistic_75 <-  model_logistic_sem_correlacionadas_75$resample %>% 
    select(Resample, ROC) %>%
    rename(AUC = ROC) 


```

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}



result_model_logistic_75 %>%     
    summarise(media = mean(AUC), sd = sd(AUC)) %>% 
    rename("Média AUC" = media, "Desvio-padrão AUC" = sd) %>% 
    mutate_if(is.numeric, percent) %>% 
    kable(caption = "\\label{tab_75}Resultados para retirada de variáveis com correlação maior que 0,75")

```





```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, results='asis'}


texreg(model_logistic_sem_correlacionadas_75$finalModel, fontsize = "footnotesize", custom.model.names = c("Regressão logística"), caption = "Coeficientes estimados na regressão logística com exclusão de uma variável em pares com mais de 0,75 de correlação", label = "reg:log_75",)

```











\newpage

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE }
pares_avaliacao_70 <- correlacoes_df %>% 
    mutate(par = row_number()) %>% 
    gather(variavel, valor,-correlacao, -par  ) %>% 
    mutate(formula =paste0("Diagnosis ~ . -", valor)) %>% 
    filter(correlacao > 0.70 ) 



result_pares_avaliacao_70 <- pares_avaliacao_70 %>%  
    rowwise() %>% 
    do( resultado = media_roc_formula(.$formula, treino)    ) %>% 
    as.tibble() 

pares_avaliacao_com_result_70 <-  pares_avaliacao_70 %>% 
    bind_cols(result_pares_avaliacao_70) %>% 
    unnest() %>% 
    mutate(indice =  if_else((row_number()-1) %% 2   == 0,"media","dp" )) %>% 
    spread(indice, resultado) %>% 
    mutate(media = unlist(media)) %>% 
    select(par, correlacao, valor, formula, media, dp ) %>% 
    group_by(par) %>% 
    mutate(maior_media = max(media)) %>% 
    mutate(exclui = media != maior_media ) %>% 
    ungroup() %>% 
    arrange(par, desc(media))


```


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:reg_log}Representação das curvas ROC de todas as avaliações da regressão logística com variáveis correlacionadas a partir de 0,7 retiradas"}

formula_sem_variaveis_70 <- pares_avaliacao_com_result_70 %>%
    filter(exclui) %>% 
    select(valor) %>% 
    summarise(valor = paste0(" Diagnosis ~ . -",str_flatten(valor, collapse = " -"))) %>% 
    unlist()
    
model_logistic_sem_correlacionadas_70 <- train(
    
    as.formula(formula_sem_variaveis_70),
    treino,
    metric = "ROC",
    method = "glm",
    trControl = controle_cv,
    preProcess = c( "center", "scale"),
    family=binomial(link='logit')
    

)



ggplot(model_logistic_sem_correlacionadas_70$pred, aes(m = M, d = obs, color = Resample )) +
    geom_roc( labels = FALSE  ) +
    coord_equal() + style_roc() + ggtitle("ROC", subtitle = "Métricas para diversos thresholds" )

    



```



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

result_model_logistic_70 <-  model_logistic_sem_correlacionadas_70$resample %>% 
    select(Resample, ROC) %>%
    rename(AUC = ROC) 


```

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}



result_model_logistic_70 %>%     
    summarise(media = mean(AUC), sd = sd(AUC)) %>% 
    rename("Média AUC" = media, "Desvio-padrão AUC" = sd) %>% 
    mutate_if(is.numeric, percent) %>% 
    kable(caption = "\\label{tab_70}Resultados para retirada de variáveis com correlação maior que 0,70")

```





```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, results='asis'}


texreg(model_logistic_sem_correlacionadas_70$finalModel, fontsize = "footnotesize", custom.model.names = c("Regressão logística"), caption = "Coeficientes estimados na regressão logística com exclusão de uma variável em pares com mais de 0.70 de correlação", label = "reg:log_70",)

```




\newpage

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE }
pares_avaliacao_60 <- correlacoes_df %>% 
    mutate(par = row_number()) %>% 
    gather(variavel, valor,-correlacao, -par  ) %>% 
    mutate(formula =paste0("Diagnosis ~ . -", valor)) %>% 
    filter(correlacao > 0.60 ) 



result_pares_avaliacao_60 <- pares_avaliacao_60 %>%  
    rowwise() %>% 
    do( resultado = media_roc_formula(.$formula, treino)    ) %>% 
    as.tibble() 

pares_avaliacao_com_result_60 <-  pares_avaliacao_60 %>% 
    bind_cols(result_pares_avaliacao_60) %>% 
    unnest() %>% 
    mutate(indice =  if_else((row_number()-1) %% 2   == 0,"media","dp" )) %>% 
    spread(indice, resultado) %>% 
    mutate(media = unlist(media)) %>% 
    select(par, correlacao, valor, formula, media, dp ) %>% 
    group_by(par) %>% 
    mutate(maior_media = max(media)) %>% 
    mutate(exclui = media != maior_media ) %>% 
    ungroup() %>% 
    arrange(par, desc(media))

```



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:reg_log}Representação das curvas ROC de todas as avaliações da regressão logística com variáveis correlacionadas a partir de 0,6 retiradas"}

formula_sem_variaveis_60 <- pares_avaliacao_com_result_60 %>%
    filter(exclui) %>% 
    select(valor) %>% 
    summarise(valor = paste0(" Diagnosis ~ . -",str_flatten(valor, collapse = " -"))) %>% 
    unlist()
    
model_logistic_sem_correlacionadas_60 <- train(
    
    as.formula(formula_sem_variaveis_60),
    treino,
    metric = "ROC",
    method = "glm",
    trControl = controle_cv,
    preProcess = c( "center", "scale"),
    family=binomial(link='logit')
    

)



ggplot(model_logistic_sem_correlacionadas_60$pred, aes(m = M, d = obs, color = Resample )) +
    geom_roc( labels = FALSE  ) +
    coord_equal() + style_roc() + ggtitle("ROC", subtitle = "Métricas para diversos thresholds" )

    



```



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

result_model_logistic_60 <-  model_logistic_sem_correlacionadas_60$resample %>% 
    select(Resample, ROC) %>%
    rename(AUC = ROC) 


```

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}



result_model_logistic_60 %>%     
    summarise(media = mean(AUC), sd = sd(AUC)) %>% 
    rename("Média AUC" = media, "Desvio-padrão AUC" = sd) %>% 
    mutate_if(is.numeric, percent) %>% 
    kable(caption = "\\label{tab_60}Resultados para retirada de variáveis com correlação maior que 0,60")

```





```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, results='asis'}


texreg(model_logistic_sem_correlacionadas_60$finalModel, fontsize = "footnotesize", custom.model.names = c("Regressão logística"), caption = "Coeficientes estimados na regressão logística com exclusão de uma variável em pares com mais de 0,60 de correlação", label = "reg:log_60",)

```

\newpage

\subsection{Regressão logística lasso-ridge}

Uma outra forma de retirar variáveis do modelo de forma natural é aplicar uma penalidade para um cada número grande de variáveis. É isso que as regressões do tipo Ridge e Lasso fazem. 

O modelo mostrado nessa seção é rodado com várias parametrizações. Este modelo conjuga a penalização do tipo ridge com a penalização do tipo lasso.

Cada parametrização do modelo rodado nesta seção possui dois valores. Um dos valores define que peso deve ser dado a cada tipo de penalização ridge ou lasso. O outro parâmetro regula a intensidade da penalização.

Os resultados para várias parametrizações é mostrado pela Figura \ref{fig:roc_net}. Os resultados de cada parametrização são mostrados na Tabela \ref{tab_lasso-ridge} em ordem decrescente de AUC.


\newpage

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:roc_net}Média do AUC das parametrizações da regressão logística do tipo lasso-ridge"}


set.seed(13)

model_net <- train(
    
    Diagnosis ~ .,
    treino,
    metric = "ROC",
    method = "glmnet",
    trControl = controle_cv,
    preProcess = c( "center", "scale"),
    tuneGrid = expand.grid(
         alpha = c(0,0.5,0.75,0.1,0.125,0.15,0.25,0.5, 1),
         lambda = 0:10/500
     )    
    

)


plot(model_net)







```

```{r, cache=TRUE}


resultados_net <- model_net$resample %>% 
    group_by(alpha, lambda) %>% 
    summarise(media = mean(ROC), "Desvio-padrão AUC" = sd(ROC)) %>% 
    arrange(desc(media)) %>% 
    rename("Média AUC" = media) 


kable(resultados_net, digits = 7, caption = "\\label{tab_lasso-ridge}Resultados da regressão lasso-ridge")




```

A regressão também foi rodada usando a mesma seleção de variáveis da regressão logística simples anterio: sem um das variáveis de cada par com correlação maior que 0,7. O resultado foi pior do que o da regressão com todas as variáveis, conform podemos ver na Figura \ref{fig:roc_net_sem} e na Tabela \ref{tab_lasso-ridge_sem}.


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:roc_net_sem}Média do AUC das parametrizações da regressão logística do tipo lasso-ridge sem variáveis altamente correlacionadas"}





set.seed(13)

model_net_sem <- train(
    
    as.formula(formula_sem_variaveis_70),
    treino,
    metric = "ROC",
    method = "glmnet",
    trControl = controle_cv,
    preProcess = c( "center", "scale"),
    tuneGrid = expand.grid(
         alpha = c(0,0.5,0.75,0.1,0.125,0.15,0.25,0.5, 1),
         lambda = 0:10/500
     )    
    

)


plot(model_net)


resultados_net_sem <- model_net$resample %>% 
    group_by(alpha, lambda) %>% 
    summarise(media = mean(ROC), "Desvio-padrão AUC" = sd(ROC)) %>% 
    arrange(desc(media)) %>% 
    rename("Média AUC" = media)






```

```{r, cache=TRUE}


kable(resultados_net_sem, digits = 7, caption = "\\label{tab_lasso-ridge_sem}Resultados da regressão lasso-ridge sem variáveis altamente correlacionadas")



```



Uma outra forma de reduzir a dimensionalidade do probelam é usar o método PCA para transformar as variáveis em componentes principais em menor número mas com boa parte da informação original. O resultado foi pior do que o da regressão com todas as variáveis, conform podemos ver na Figura \ref{fig:roc_net_pca} e na Tabela \ref{tab_lasso-ridge_pca}.



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:roc_net_pca}Média do AUC das parametrizações da regressão logística do tipo lasso-ridge com pré-processamento por PCA"}



set.seed(13)

model_net_pca <- train(
    
    Diagnosis ~ .,
    treino,
    metric = "ROC",
    method = "glmnet",
    trControl = controle_cv,
    preProcess = c( "center", "scale", "pca"),
    tuneGrid = expand.grid(
         alpha = c(0,0.5,0.75,0.1,0.125,0.15,0.25,0.5, 1),
         lambda = 0:10/500
     )    
    

)


plot(model_net_pca)


resultados_net_pca <- model_net$resample %>% 
    group_by(alpha, lambda) %>% 
    summarise(media = mean(ROC), "Desvio-padrão AUC" = sd(ROC)) %>% 
    arrange(desc(media)) %>% 
    rename("Média AUC" = media)





```


```{r}



kable(resultados_net_pca, digits = 7, caption = "\\label{tab_lasso-ridge_pca}Resultados da regressão lasso-ridge com pré-processamento PCA")







```

\newpage

\subsection{Árvore de decisão e Floresta Aleatória}


Os resultados da aplicação de árvore de decisão são mostrados na Figura \ref{fig:roc_rpart} e na Tabela \ref{tab_rpart}.

Já os resultados da aplicação de Floresta Aleatória, bem melhores, são mostrados na Figura \ref{fig:roc_ranger} e na Tabela \ref{tab_ranger}. 




```{r, fig.cap="\\label{fig:roc_rpart}Média do AUC das parametrizações do método de Árvore de decisão", cache= TRUE }




model_tree <- train(
    
    Diagnosis  ~ .,
    treino,
    metric = "ROC",
    method = "rpart",
    trControl = controle_cv,
    preProcess = c( "center", "scale")


)

plot(model_tree$finalModel)



resultados_tree <- model_tree$resample %>% 
    group_by(cp) %>% 
    summarise(media = mean(ROC), "Desvio-padrão AUC" = sd(ROC)) %>% 
    arrange(desc(media)) %>% 
    rename("Média AUC" = media)


```


```{r, cache = TRUE}


kable(resultados_tree, digits = 7, caption = "\\label{tab_rpart}Resultados do método de Árvore de Decisão")


```






```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:roc_ranger}Média do AUC das parametrizações do método de Floresta Aleatória", cache= TRUE}



model_ranger <- train(
    
    Diagnosis  ~ .,
    treino,
    metric = "ROC",
    method = "ranger",
    trControl = controle_cv,
    preProcess = c( "center", "scale"),
    verbose = TRUE


)




resultados_ranger <- model_ranger$resample %>% 
    group_by(mtry, splitrule) %>% 
    summarise(media = mean(ROC), "Desvio-padrão AUC" = sd(ROC)) %>% 
    arrange(desc(media)) %>% 
    rename("Média AUC" = media)



plot(model_ranger)





```




```{r}



kable(resultados_ranger, digits = 7, caption = "\\label{tab_ranger}Resultados do método de Floresta Aleatória")


```





```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE }



resultados_modelo <- function(modelo)
{
    res <- modelo$resample %>% 
        select(-Sens, -Spec) %>% 
        group_by_at(vars(-ROC, -Resample)) %>% 
        summarise(media = mean(ROC), "Desvio-padrão AUC" = sd(ROC)) %>% 
        arrange(desc(media)) %>% 
        rename("Média AUC" = media)
    
    res
    
}








```

\newpage

\subsection{Modelo Aditivo Generalizado} 


O Modelo Aditivo Generalizado (GAM) estende a regressão logística simples aplicando funções não lineares às variáveis. Os resultados são mostrados na Figura \ref{fig:roc_gam} e na Tabela \ref{tab_gam}.



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:roc_gam}Média do AUC das parametrizações do método aditivo generalizado (GAM)"}





set.seed(13)

model_gamboost <- train(
    
    Diagnosis ~ .,
    treino,
    metric = "ROC",
    method = "gamboost",
    trControl = controle_cv,
    preProcess = c( "center", "scale"),
    tuneGrid = expand.grid(
          mstop = c(200, 300, 400, 500),
          prune = c("yes")
          
      )    
    

)


plot(model_gamboost)


resultados_gamboost <- model_gamboost$resample %>% 
    group_by(mstop, prune) %>% 
    summarise(media = mean(ROC), "Desvio-padrão AUC" = sd(ROC)) %>% 
    arrange(desc(media)) %>% 
    rename("Média AUC" = media)










```




```{r}

kable(resultados_gamboost, digits = 7, caption = "\\label{tab_gam}Resultados do método aditivo generalizado (GAM)")

```




\subsection{Support Vector Machine} 


O modelo Support Vector Machine tenta separar os pontos da melhor forma possível usando hiperplanos no espaço. Os resultados são mostrados na Figura \ref{fig:roc_svm} e na Tabela \ref{tab_svm}.




```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:roc_svm}Média do AUC das parametrizações do método Support Vector Machine"}



set.seed(13)

model_svm <- train(
    
    Diagnosis ~ .,
    treino,
    metric = "ROC",
    method = "svmRadialWeights",
    trControl = controle_cv,
    preProcess = c( "center", "scale"),
    tuneGrid = expand.grid(
        C = c(.5, 1, 2, 3, 4, 5, 6, 7, 8),
        sigma = c( .15, .01, 0.005, 0.001),
        Weight = 2
          
      )    
)


plot(model_svm)


resultados_svm <- model_svm$resample %>% 
    group_by(C, sigma) %>% 
    summarise(media = mean(ROC), "Desvio-padrão AUC" = sd(ROC)) %>% 
    arrange(desc(media)) %>% 
    rename("Média AUC" = media)







```




```{r}

kable(resultados_svm, digits = 7, caption = "\\label{tab_svm}Resultados do método Support Vector Machine")



```



\subsection{Modelo Ensemble} 


Foi criado um modelo Ensemble com 5 modelos escolhidos nas seções anteriores. Este modelo decide a classificação da variável de resposta levando em conta  maioria dos votos dos 5 modelos, de acordo com o threshold escolhido. Por exemplo se o threshold é 0,4, o caso é considerado maligno se 3 ou mais modelos apontarem que a probabilidade de malignidade é maior que 0,4.

O resultado deste modelo é apontado na tabela \ref{tab_ens}.



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

# 
# resultados_modelo(model_logistic_sem_correlacionadas_70) 
# 
# resultados_modelo(model_net) 
# 
# resultados_modelo(model_ranger) 
# 
# resultados_modelo(model_gamboost)
# 
# resultados_modelo(model_svm)
# 


```



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}



pred_logistic <- model_logistic_sem_correlacionadas_70$pred %>% 
    semi_join(model_logistic_sem_correlacionadas_70$bestTune) %>% 
    mutate(modelo = "Logística sem coorrel")

pred_net <- model_net$pred %>% 
    semi_join(model_net$bestTune) %>% 
    mutate(modelo = "Logística lasso-ridge")
    
pred_svm <- model_svm$pred %>% 
    semi_join(model_svm$bestTune) %>% 
    mutate(modelo = "SVM")

pred_boost <- model_gamboost$pred %>% 
    semi_join(model_gamboost$bestTune) %>% 
    mutate(modelo = "Gam") 

pred_ranger <- model_ranger$pred %>% 
    semi_join(model_ranger$bestTune) %>% 
    mutate(modelo = "Floresta")


pred_ensemble_todos <- bind_rows(pred_logistic, pred_net, pred_boost, pred_ranger, pred_svm )



pred_ensemble_mediana <- pred_ensemble_todos %>% 
    separate(Resample, c("Fold", "Repeat")) %>% 
    group_by(Repeat, rowIndex) %>% 
    summarise(M = median(M), B= median(B), n = n(), obs = unique(obs)) 



ret_roc <- function(data)
{
    roc(data$obs,data$M)
}


ret_roc_auc <- function(data)
{
    unlist(as.numeric(roc(data$obs,data$M)$auc))
}


pred_ensemble_mediana_foldado <- model_ranger$pred %>% 
    semi_join(model_ranger$bestTune) %>% 
    separate(Resample, c("Fold", "Repeat")) %>% 
    select(Fold, Repeat, rowIndex) %>% 
    inner_join(pred_ensemble_mediana, by = c("Repeat", "rowIndex"), suffix = c("","_") )  %>% 
    group_by(Fold, Repeat) %>% 
    nest() %>% 
    mutate( roc = map(data, ret_roc), auc = unlist(map(data, ret_roc_auc))  )




resultado_ensemble_pra_mostrar <- tibble( "Média AUC" = mean(pred_ensemble_mediana_foldado$auc), "Desvio-padrão AUC" = sd(pred_ensemble_mediana_foldado$auc) )


kable(resultado_ensemble_pra_mostrar, digits = 7, caption = "\\label{tab_ens}Resultados do método Ensenble, juntando os 5 modelos escolhidos")



```


\newpage

\subsection{Avaliação do impacto das variáveis}


Para avaliar o impacto de cada variável nos resultados de cada um dos 5 modelos, geramos casos sintéticos e avaliamos a probabilidade de esses casos serem malignos segundo cada modelo.

Dois grupos de casos sintéticos foram gerados. No primeiro grupo, mostrado na Figura \ref{fig:varia_0.5}, para cada variável explicativa, foram criados casos onde o valor das outras variávei. No segundo grupo, mostrado na Figura \ref{fig:varia_0.65} para avaliar uma região onde os casos têm mais chance de ser malignos, as variáveis que não estão variando são mantidas no quantil 0.65.

É possível verificar que algumas variáveis parecem não afetar a chance do caso ser maligno, como o desvio-padrão da dimensão fractal. Outras aumentam bastante o risco quando em valores mais altos segundo alguns modelos, como a pior medida de área na regressão logística simples. Outras, por outro lado, parecem ser consideradas por vários modelos, como a medida de pior concavidade de pontos. Algumas medidas parecem ter efeitos não lineares ou mesmo contrários à intuição (pelo menos a intuição leiga), principalmente na região onde todas as outras variáveis estão fixas no quantil 0.65.

\newpage

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:varia_0.5}Casos sintéticos e suas probabilidades de serem malignas. Em cada gráfico, uma variável varia pelos quantis e as outras são mantidas na mediana dos valores"}


medias_treino <- treino %>% 
    select(-Diagnosis) %>% 
    summarise_all(mean) %>% 
    gather(variavel, media) 

dps_treino <- treino %>% 
    select(-Diagnosis) %>% 
    summarise_all(sd) %>% 
    gather(variavel, dp) 

mediana_treino <- treino %>% 
    select(-Diagnosis) %>% 
    summarise_all(median) %>% 
    gather(variavel, mediana) 


variaveis <- medias_treino %>% 
    select(variavel)

caso_media <- medias_treino %>% 
    spread(variavel, media)


quantis <- treino %>% 
    select(-Diagnosis) %>% 
    gather(variavel, valor) %>% 
    crossing( tibble( q = seq(0,1, 0.05))   ) %>% 
    group_by(variavel,q ) %>% 
    summarise( valor = quantile(valor, mean(q))) 
    

casos <- variaveis %>% 
    crossing(variaveis) %>% 
    rename(fixa = variavel1) %>% 
    crossing(tibble( q = seq(0,1, 0.05)) ) %>% 
    arrange(q, variavel, fixa) %>% 
    mutate(caso = (row_number()-1) %/% nrow(variaveis) + 1) %>% 
    mutate(q_cada_variavel = if_else(variavel == fixa, q, 0.5 )) %>% 
    inner_join(quantis, by=c("q_cada_variavel" = "q", "fixa" = "variavel") ) %>%
    select(-q_cada_variavel) %>% 
    spread(fixa, valor)
    
prev_boost <- predict(model_gamboost, casos, type = "prob") %>% 
    mutate(modelo = "GAM") %>% 
    bind_cols(casos)

prev_svm <- predict(model_svm, casos, type = "prob") %>% 
    mutate(modelo = "SVM") %>% 
    bind_cols(casos)

prev_ranger <- predict(model_ranger, casos, type = "prob") %>% 
    mutate(modelo = "Floresta") %>% 
    bind_cols(casos)

prev_log_sem <- predict(model_logistic_sem_correlacionadas_70, casos, type = "prob") %>% 
    mutate(modelo = "Logística sem correl") %>% 
    bind_cols(casos)

prev_log_net <- predict(model_net, casos, type = "prob") %>% 
    mutate(modelo = "Logística lasso-ridge") %>% 
    bind_cols(casos)



prev <- 
    bind_rows(prev_svm, prev_boost, prev_ranger, prev_log_sem, prev_log_net)



prev %>% 
    ggplot() +
    geom_line( aes(x = q, y = M, color = modelo) ) +
    facet_wrap( ~variavel) +
    theme_minimal() +
    theme(
        aspect.ratio = .4,
        strip.text = element_text(size = 5),
        strip.background.y = element_rect(size = c(0.1,0.1)),
        strip.switch.pad.grid = unit(.01,"cm"),
        strip.switch.pad.wrap = unit(.01,"cm"),
        axis.text =  element_text(size = 4) 
        
        )
    


```









```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:varia_0.65}Casos sintéticos e suas probabilidades de serem malignas. Em cada gráfico, uma variável varia pelos quantis e as outras são mantidas no quantil 0.65 dos valores"}


medias_treino <- treino %>% 
    select(-Diagnosis) %>% 
    summarise_all(mean) %>% 
    gather(variavel, media) 

dps_treino <- treino %>% 
    select(-Diagnosis) %>% 
    summarise_all(sd) %>% 
    gather(variavel, dp) 

mediana_treino <- treino %>% 
    select(-Diagnosis) %>% 
    summarise_all(median) %>% 
    gather(variavel, mediana) 


variaveis <- medias_treino %>% 
    select(variavel)

caso_media <- medias_treino %>% 
    spread(variavel, media)


quantis <- treino %>% 
    select(-Diagnosis) %>% 
    gather(variavel, valor) %>% 
    crossing( tibble( q = seq(0,1, 0.05))   ) %>% 
    group_by(variavel,q ) %>% 
    summarise( valor = quantile(valor, mean(q))) 
    

casos <- variaveis %>% 
    crossing(variaveis) %>% 
    rename(fixa = variavel1) %>% 
    crossing(tibble( q = seq(0,1, 0.05)) ) %>% 
    arrange(q, variavel, fixa) %>% 
    mutate(caso = (row_number()-1) %/% nrow(variaveis) + 1) %>% 
    mutate(q_cada_variavel = if_else(variavel == fixa, q, 0.65 )) %>% 
    inner_join(quantis, by=c("q_cada_variavel" = "q", "fixa" = "variavel") ) %>%
    select(-q_cada_variavel) %>% 
    spread(fixa, valor)
    
prev_boost <- predict(model_gamboost, casos, type = "prob") %>% 
    mutate(modelo = "GAM") %>% 
    bind_cols(casos)

prev_svm <- predict(model_svm, casos, type = "prob") %>% 
    mutate(modelo = "SVM") %>% 
    bind_cols(casos)

prev_ranger <- predict(model_ranger, casos, type = "prob") %>% 
    mutate(modelo = "Floresta") %>% 
    bind_cols(casos)

prev_log_sem <- predict(model_logistic_sem_correlacionadas_70, casos, type = "prob") %>% 
    mutate(modelo = "Logística sem correl") %>% 
    bind_cols(casos)

prev_log_net <- predict(model_net, casos, type = "prob") %>% 
    mutate(modelo = "Logística lasso-ridge") %>% 
    bind_cols(casos)


prev <- 
    bind_rows(prev_svm, prev_boost, prev_ranger, prev_log_sem, prev_log_net)



prev %>% 
    ggplot() +
    geom_line( aes(x = q, y = M, color = modelo) ) +
    facet_wrap( ~variavel ) +
    theme_minimal() +
    theme(
        aspect.ratio = .4,
        strip.text = element_text(size = 5),
        strip.background.y = element_rect(size = c(0.1,0.1)),
        strip.switch.pad.grid = unit(.01,"cm"),
        strip.switch.pad.wrap = unit(.01,"cm"),
        axis.text =  element_text(size = 4) 
        )
    


```


\newpage









```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}
modelo <- model_gamboost

roc_best_modelo <- function(modelo)
{

    dados_roc <- modelo$pred %>% 
        semi_join(modelo$bestTune) %>% 
        mutate(obs = if_else(obs == "B", 0, 1))

    dados_curva <- roc(dados_roc$obs, dados_roc$M)
    
    tibble( sensitivities = dados_curva$sensitivities, 
            specificities= dados_curva$specificities,  
            thresholds = dados_curva$thresholds,
            auc = dados_curva$auc
            ) 
    
}   


pred_best_modelo <- function(modelo)
{
    modelo$pred %>% 
        semi_join(modelo$bestTune)

}

    
plota_roc_modelo <-  function(modelo, prob, nome)
{
    
    
    
    
    roc_modelo <-  roc_best_modelo(modelo)
    pred_modelo <- pred_best_modelo(modelo)
    
    
    threshold_escolhido <- roc_modelo %>% 
        filter(thresholds >= prob) %>% 
        top_n(n = 1, wt = desc(thresholds )) 
    
    
    ggplot(pred_modelo ) +
        geom_roc( labels = FALSE, labelround = 2, labelsize = 3, n.cuts = 0, aes(m = M, d = obs )  ) +
        geom_point(data = threshold_escolhido, aes(y = sensitivities, x = 1-specificities), size = 3) +
        geom_text(data = threshold_escolhido, aes(y = sensitivities, x = 1-specificities, label = paste0(percent(sensitivities), " / ", percent(1-specificities)) ), nudge_x = .11, nudge_y = -.05, size = 3 ) +
        coord_equal() + style_roc() + ggtitle(paste0("ROC - ", nome), subtitle = paste0("Corte na probabilidade ", prob )) + style_roc()
    
}


plota_roc_ensemble <-  function(modelo, prob, nome)
{
    prob <- 0.3
    nome <- "Ensemble"
    dados_curva <- roc(pred_ensemble_mediana$obs, pred_ensemble_mediana$M)
    
    roc_modelo <- tibble( sensitivities = dados_curva$sensitivities, 
            specificities= dados_curva$specificities,  
            thresholds = dados_curva$thresholds,
            auc = dados_curva$auc
            ) 
    
    
    
    pred_modelo <- pred_ensemble_mediana
    
    
    threshold_escolhido <- roc_modelo %>% 
        filter(thresholds >= prob) %>% 
        top_n(n = 1, wt = desc(thresholds )) 
    
    
    ggplot(pred_modelo ) +
        geom_roc( labels = FALSE, labelround = 2, labelsize = 3, n.cuts = 0, aes(m = M, d = obs )  ) +
        geom_point(data = threshold_escolhido, aes(y = sensitivities, x = 1-specificities), size = 3) +
        geom_text(data = threshold_escolhido, aes(y = sensitivities, x = 1-specificities, label = paste0(percent(sensitivities), " / ", percent(1-specificities)) ), nudge_x = .11, nudge_y = -.05, size = 3 ) +
        coord_equal() + style_roc() + ggtitle(paste0("ROC - ", nome), subtitle = paste0("Corte na probabilidade ", prob )) + style_roc()
    
}
```


\subsection{Modelos escolhidos e seus thresholds}


Foram escolhidas 5 parametrizações de 5 tipos de modelos para avaliação com os dados de teste, separados antes do início da análise. Para cad um destes modelos, foi escolhido um threshold de forma a minimizar o risco de se perder um caso maligno, mas evitando um número muito grande de falsos positivos. Esta escolha foi feita visualmente com a análise da curva ROC. As Figuras \ref{thre_gam}, \ref{thre_log}, \ref{thre_lassoridge}, \ref{thre_svm}, \ref{thre_ranger}, \ref{thre_ens},  





```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:thre_gam}Escolha do threshold modelo GAM"}
plota_roc_modelo(model_gamboost, 0.25, "Gam")
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:thre_log}Escolha do threshold modelo de regressão logística"}
plota_roc_modelo(model_logistic_sem_correlacionadas_70, 0.1, "Logistica sem correlacionados")
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:thre_log_lassoridge}Escolha do threshold modelo de regressão logística lasso-ridge"}
plota_roc_modelo(model_net, 0.35, "Logistica lasso-ridge")
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:thre_svm}Escolha do threshold modelo SVM"}
plota_roc_modelo(model_svm, 0.2, "SVM")
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:thre_ranger}Escolha do threshold modelo Floresta Aleatória"}
plota_roc_modelo(model_ranger, 0.35, "Random forest")
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE, fig.cap="\\label{fig:thre_ens}Escolha do threshold modelo Ensemble"}
plota_roc_ensemble()

# roc_svm
# 
# roc_net
# 
# roc_logistic
# 
# roc_ranger
# 





```


\newpage


\section{Avaliação dos resultados} \label{aval}


A seguir são mostrados os resultados da aplicação dos modelos escolhidos nos dados de teste.


Resultados do modelo Support Vector Machine:

```{r message=FALSE, warning=FALSE, cache=TRUE, paged.print=FALSE}


confusao_teste <- function(modelo, threshold)
{

    prev_teste_svm <- predict(modelo, teste, type = "prob") 
    
    
    pred_teste_svm <- prev_teste_svm %>% 
        mutate(pred = as.factor( if_else(M > threshold, "M", "B"))) %>% 
        select(pred)
    
    conf_svm <- confusionMatrix(data = pred_teste_svm$pred, reference =  teste$Diagnosis, positive = "M")
}


gera_dados_confusao_teste <- function(modelo, threshold)
{

    prev_teste_svm <- predict(modelo, teste, type = "prob") 
    
    
    pred_teste_svm <- prev_teste_svm %>% 
        mutate(pred = as.factor( if_else(M > threshold, "M", "B"))) %>% 
        select(pred)
    
    #tibble(data = pred_teste_svm$pred, reference =  teste$Diagnosis, positive = "M")
    
    bind_cols(pred_teste_svm, teste) 
    
}




confusao_svm <- confusao_teste(model_svm, 0.2)
confusao_svm



```

Resultados do modelo Generalized Additive Model (GAM):



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}


confusao_boost <- confusao_teste(model_gamboost, 0.25)
confusao_boost


```


Resultados do modelo Regressão Logística Simples sem variáveis altamente correlacionadas:



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}


confusao_log <- confusao_teste(model_logistic_sem_correlacionadas_70, 0.1)
confusao_log



```

Resultados do modelo Regressão Logística Lasso-Ridge:



```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

confusao_net <- confusao_teste(model_net, 0.35)
confusao_net




```

Resultados do modelo Floresta Aleatória:


```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}



confusao_ranger <- confusao_teste(model_ranger, 0.35)
confusao_ranger



```

Resultados do modelo Ensemble:

```{r message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}

pred_test_1 <- predict(model_logistic_sem_correlacionadas_70, teste, type = "prob") %>% 
    mutate(row = row_number())  

pred_test_2 <- predict(model_gamboost, teste, type = "prob") %>% 
    mutate(row = row_number())  

pred_test_3 <- predict(model_svm, teste, type = "prob") %>% 
    mutate(row = row_number())  

pred_test_4 <- predict(model_net, teste, type = "prob") %>% 
    mutate(row = row_number())  
        
pred_test_5 <- predict(model_ranger , teste, type = "prob") %>% 
    mutate(row = row_number())  
    
pred_teste_ensemble <- bind_rows(pred_test_1, pred_test_2, pred_test_3, pred_test_4, pred_test_5) %>% 
    group_by(row) %>% 
    summarise (M = median(M)) %>% 
    mutate(pred = as.factor( if_else(M > 0.3, "M", "B"))) 






confusao_ensemble <- confusionMatrix(data = pred_teste_ensemble$pred, reference =  teste$Diagnosis, positive = "M")
    
confusao_ensemble        







```



```{r message=FALSE, warning=FALSE, paged.print=FALSE}


dados_confusao_teste1 <- gera_dados_confusao_teste(model_svm, 0.2) %>% 
    mutate(modelo = "svm", linha = row_number())

dados_confusao_teste2 <- gera_dados_confusao_teste(model_gamboost, 0.25) %>% 
    mutate(modelo = "gam", linha = row_number())

dados_confusao_teste3 <- gera_dados_confusao_teste(model_ranger , 0.35) %>% 
    mutate(modelo = "ranger", linha = row_number())

dados_confusao_teste4 <- gera_dados_confusao_teste(model_logistic_sem_correlacionadas_70, 0.1) %>% 
    mutate(modelo = "log", linha = row_number())

dados_confusao_teste5 <- gera_dados_confusao_teste(model_net, 0.35) %>% 
    mutate(modelo = "lassoridge", linha = row_number())


dados_confusao_teste_todos <- bind_rows(
    
    dados_confusao_teste1,
    dados_confusao_teste2,
    dados_confusao_teste3,
    dados_confusao_teste4,
    dados_confusao_teste5
    
)

pred_errados_teste <- dados_confusao_teste_todos %>% 
    filter(pred != Diagnosis) %>% 
    group_by(linha, pred, Diagnosis) %>% 
    summarise(n= n())

```

Alguns casos foram diagnosticados de forma errada por todos os modelos. Chama a atenção o caso de número 50 da base de testes, que tinha o diagnóstico real maligno mas foi diagnosticado como benigno por todos os modelos, apesar de todo o viés imposto para que este tipo de erro não acontecesse. Trata-se de um possível ruído na base.


A Figura \ref{fig:zonas_erro} mostra a posição dos casos na base de teste em relação a cada atributo. os pontos pretos se tratam de asos diagnosticados corretamente. Os pontos azuis são falsos positivos. A cada modelo que erra, um ponto aparece. os pontos vermelhos são os falsos negativos.

```{r fig.cap="\\label{fig:zonas_erro}Casos na base de testes. Os pontos pretos indicam diagnósticos corretos, os pontos azuis indicam falsos positivos, os vermelhor, falsos negativos"}


dados_confusao_teste_todos_tidy <- dados_confusao_teste_todos %>% 
    gather(atributo, valor, - pred,-Diagnosis, - modelo, - linha) %>% 
    select(-linha)

dados_confusao_teste_todos_certos <- 
    dados_confusao_teste_todos_tidy %>% 
    filter(pred == Diagnosis)

dados_confusao_teste_todos_falso_positivo <- 
    dados_confusao_teste_todos_tidy %>% 
    filter(pred == "M" & Diagnosis == "B")

dados_confusao_teste_todos_falso_negativo <- 
    dados_confusao_teste_todos_tidy %>% 
    filter(pred == "B" & Diagnosis == "M")


ggplot() +
    geom_jitter(data = dados_confusao_teste_todos_certos, aes(x = valor, y = 0), alpha = 0.05, size = 0.5) +
    geom_jitter(data = dados_confusao_teste_todos_falso_positivo, aes(x = valor, y = 0), alpha = 0.5, color = "blue", size = 0.5) +
    geom_jitter(data = dados_confusao_teste_todos_falso_negativo , aes(x = valor, y = 0), alpha = 0.5, color = "red", size = 0.5) +
    facet_wrap(~atributo, scales = "free") +
    theme_minimal() +
    theme(
        aspect.ratio = .4,
        strip.text = element_text(size = 5),
        strip.background.y = element_rect(size = c(0.1,0.1)),
        strip.switch.pad.grid = unit(.01,"cm"),
        strip.switch.pad.wrap = unit(.01,"cm"),
        axis.text =  element_text(size = 4) ,
        axis.text.y = element_blank()
        
        )
    


```




\section {Conclusões}


Os modelos que têm maior acurária nos dados de teste foram o de Floresta Aleatória e Generalized Additive Model com aproximadamente 95%.

os modelos que apresentaram menor variância usando como referência o desvio-padrão do AUC da parametrização de melhor média de AUC para as 40 execuções do 4-fold cross validation repetido 5 vezes nos dados de treinamento foi o modeo Support Vector Machine com 0,00235.

Quatro modelos erraram apenas um dos casos graves do caso de teste, atingindo a sensibilidade de aproximadamente 98%. O único modelo que errou dois casos foi o de Floresta Aleatória.

As regiões de cada atributo com casos mais dificeis de classificar podem ser vistas na Figura \ref{fig:zonas_erro}. Um exemplo de zona com uma densidade alta de falsos positivos e uma densidade relativamente baixa de diagnósticos corretos são os casos com textura média levemente alta.

Um dos caso de teste se mostrou com falso negativo para todos os modelos, o que é um indicativo forte de que é um ruído, dado a alta sensibilidade dos modelos e o fato de serem baseados em métodos diferentes.

Os atributos mais decisivos para classificação podem ser vistos nas figuras \ref{fig:varia_0.5} e \ref{fig:varia_0.65}. A pior medida de concavidade de pontos é um exemplo de atributo em que um caso com alto valor ati8va uma probabilidade alta de cvaso maligno em muitos os modelos.







